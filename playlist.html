<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactical HUD Controller</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            pointer-events: none;
        }
        iframe.active {
            opacity: 1;
            z-index: 10;
            pointer-events: auto;
        }
        .loader {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #00FF41; font-family: monospace;
            z-index: 0;
        }

        /* Menu trigger button */
        .menu-trigger {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            border: 1px solid #00FF41;
            background: rgba(0,0,0,0.7);
            color: #00FF41;
            font-size: 20px;
            cursor: pointer;
            z-index: 50;
            border-radius: 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .menu-trigger:hover { opacity: 1; }
        body.settings-open .menu-trigger { display: none; }

        /* Stream list slide-out panel */
        .stream-list-panel {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: rgba(13, 17, 23, 0.95);
            border-left: 1px solid #00FF41;
            z-index: 40;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .stream-list-panel.visible {
            right: 0;
        }
        .stream-list-panel h3 {
            margin: 0 0 16px 0;
            color: #00FF41;
            font-family: monospace;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stream-list-panel .settings-button {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #30363d;
        }
        .stream-list-panel .btn-settings {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid #00FF41;
            color: #00FF41;
            font-family: monospace;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .stream-list-panel .btn-settings:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        .stream-list-panel .btn-settings::before {
            content: '⚙';
            font-size: 16px;
        }
        .stream-list-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid #30363d;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: #e6edf3;
            font-family: monospace;
            font-size: 12px;
        }
        .stream-list-item:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: #00FF41;
        }
        .stream-list-item.active {
            background: rgba(0, 255, 65, 0.2);
            border-color: #00FF41;
            color: #00FF41;
        }
        .stream-list-item .stream-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .stream-list-item .stream-url {
            color: #8b949e;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .stream-list-item.active .stream-url {
            color: #00FF41;
        }

        /* Settings panel */
        .settings-panel {
            display: none;
            position: fixed;
            inset: 0;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }
        .settings-panel.is-open { display: flex; }
        .settings-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            cursor: pointer;
        }
        .settings-content {
            position: relative;
            background: #0d1117;
            border: 1px solid #00FF41;
            border-radius: 8px;
            padding: 24px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .settings-content h2 {
            margin: 0 0 16px 0;
            color: #00FF41;
            font-family: monospace;
            font-size: 1.1rem;
        }
        .mode-control {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #30363d;
        }
        .mode-control .toggle-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .mode-control .toggle-label {
            color: #e6edf3;
            font-size: 13px;
            font-family: monospace;
            flex: 1;
        }
        .app-list { margin-bottom: 16px; }
        .app-row {
            display: grid;
            grid-template-columns: 100px 1fr 80px auto auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .app-row:hover {
            background: rgba(0,255,65,0.05);
            border-color: #30363d;
        }
        .app-row.selected {
            background: rgba(0,255,65,0.15);
            border-color: #00FF41;
        }
        .btn-select {
            background: transparent;
            border: 1px solid #00FF41;
            color: #00FF41;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }
        .btn-select:hover {
            background: rgba(0,255,65,0.15);
        }
        .btn-select.active {
            background: #00FF41;
            color: #000;
        }
        .app-row input {
            background: #161b22;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .app-row input:focus {
            outline: none;
            border-color: #00FF41;
        }
        .app-row .row-duration { text-align: right; }
        .btn-remove {
            background: transparent;
            border: 1px solid #f85149;
            color: #f85149;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }
        .btn-remove:hover { background: rgba(248,81,73,0.15); }
        .btn-add {
            background: transparent;
            border: 1px dashed #00FF41;
            color: #00FF41;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 16px;
        }
        .btn-add:hover { background: rgba(0,255,65,0.1); }
        .settings-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .settings-actions .btn {
            padding: 10px 18px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid;
        }
        .btn-save {
            background: #00FF41;
            color: #000;
            border-color: #00FF41;
        }
        .btn-save:hover { opacity: 0.9; }
        .btn-cancel {
            background: transparent;
            color: #8b949e;
            border-color: #30363d;
        }
        .btn-cancel:hover { border-color: #8b949e; color: #e6edf3; }
        .btn-reset {
            background: transparent;
            color: #d29922;
            border-color: #d29922;
        }
        .btn-reset:hover { background: rgba(210,153,34,0.1); }
        .settings-hint {
            color: #8b949e;
            font-size: 11px;
            margin-top: 2px;
        }
        .auto-resume-setting {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #30363d;
        }
        .auto-resume-setting .toggle-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .auto-resume-setting .toggle-label {
            color: #e6edf3;
            font-size: 13px;
            font-family: monospace;
            flex: 1;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #30363d;
            transition: 0.3s;
            border-radius: 24px;
            border: 1px solid #21262d;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: #8b949e;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #00FF41;
            border-color: #00FF41;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
            background-color: #000;
        }
        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #21262d;
            border-color: #30363d;
        }
        .toggle-switch input:disabled + .toggle-slider:before {
            background-color: #484f58;
        }
        .auto-resume-setting.disabled {
            opacity: 0.6;
        }
        .auto-resume-setting .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            margin-left: 62px;
        }
        .auto-resume-setting .time-input-group.hidden {
            display: none;
        }
        .auto-resume-setting input[type="number"] {
            background: #161b22;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 13px;
            width: 100px;
        }
        .auto-resume-setting input[type="number"]:focus {
            outline: none;
            border-color: #00FF41;
        }
        .auto-resume-setting .input-suffix {
            color: #8b949e;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="loader">INITIALIZING HUD LINK...</div>
    <div id="app-container"></div>

    <!-- Stream list slide-out panel -->
    <div id="stream-list-panel" class="stream-list-panel">
        <h3>Streams</h3>
        <div id="stream-list-content"></div>
        <div class="settings-button">
            <button type="button" class="btn-settings" id="panel-settings-btn" aria-label="Open settings" title="Settings (Ctrl+Shift+S)">Settings</button>
        </div>
    </div>

    <button type="button" class="menu-trigger" id="menu-trigger" aria-label="Open menu" title="Menu">☰</button>

    <div id="settings-panel" class="settings-panel" role="dialog" aria-label="Playlist settings">
        <div class="settings-overlay" id="settings-overlay"></div>
        <div class="settings-content">
            <h2>Playlist Settings</h2>
            <div class="mode-control">
                <div class="toggle-header">
                    <span class="toggle-label">Disable Auto Rotation:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="disable-auto-rotation">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p class="settings-hint">When enabled, auto rotation is completely disabled and streams must be selected manually.</p>
            </div>
            <div class="auto-resume-setting">
                <div class="toggle-header">
                    <span class="toggle-label">Auto-resume after idle:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-resume-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="time-input-group hidden" id="time-input-group">
                    <input type="number" id="auto-resume-timeout" min="1" max="300" step="1" value="10" placeholder="seconds">
                    <span class="input-suffix">seconds</span>
                </div>
                <p class="settings-hint">Automatically resume rotation after the specified seconds of no mouse movement when in manual mode.</p>
            </div>
            <div id="app-list" class="app-list"></div>
            <button type="button" class="btn-add" id="btn-add-app">+ Add App</button>
            <p class="settings-hint">Duration is in seconds (e.g. 120 = 2 min, 300 = 5 min). At least one app required.</p>
            <div class="settings-actions">
                <button type="button" class="btn btn-save" id="btn-save">Save & Close</button>
                <button type="button" class="btn btn-cancel" id="btn-cancel">Cancel</button>
                <button type="button" class="btn btn-reset" id="btn-reset">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        // Single source of truth: validation, storage, in-memory fallback when localStorage fails
        var Config = {
            CONFIG_KEY: 'hud-playlist-config',
            DEFAULT_APPS: [
                { id: 'weather-dash', url: 'https://devweather.securityscroll.com/#33919', duration: 120000 },
                { id: 'sec-scroll', url: 'https://dev.securityscroll.com', duration: 300000 },
                { id: 'uptime-dash', url: 'https://devuptime.securityscroll.com', duration: 120000 }
            ],
            memoryConfig: null,

            validate: function (raw) {
                if (!raw || typeof raw !== 'object' || !Array.isArray(raw.apps) || raw.apps.length === 0) return { valid: false };
                var apps = [];
                for (var i = 0; i < raw.apps.length; i++) {
                    var a = raw.apps[i];
                    if (!a || typeof a.url !== 'string' || !/^https?:\/\//i.test(a.url)) continue;
                    var dur = (typeof a.duration === 'number' && !isNaN(a.duration)) ? Math.max(1000, Math.min(86400000, a.duration)) : 60000;
                    var id = (typeof a.id === 'string' && a.id.trim()) ? a.id.trim() : ('app-' + i);
                    apps.push({ id: id, url: a.url.trim(), duration: dur });
                }
                if (apps.length === 0) return { valid: false };
                var autoResume = (typeof raw.autoResumeTimeout === 'number' && !isNaN(raw.autoResumeTimeout)) 
                    ? Math.max(0, Math.min(300000, raw.autoResumeTimeout)) 
                    : 10000; // default 10 seconds (already in milliseconds)
                var disableAuto = (typeof raw.autoRotationDisabled === 'boolean') ? raw.autoRotationDisabled : false;
                return { valid: true, config: { apps: apps, autoResumeTimeout: autoResume, autoRotationDisabled: disableAuto } };
            },

            getConfig: function () {
                try {
                    var s = localStorage.getItem(Config.CONFIG_KEY);
                    if (s) {
                        var p = JSON.parse(s);
                        var v = Config.validate(p);
                        if (v.valid) return v.config;
                    }
                } catch (e) { /* ignore */ }
                var defaultConfig = Config.memoryConfig || { apps: Config.DEFAULT_APPS.slice(), autoResumeTimeout: 10000, autoRotationDisabled: false };
                if (defaultConfig.autoResumeTimeout === undefined || defaultConfig.autoResumeTimeout === null) {
                    defaultConfig.autoResumeTimeout = 10000;
                }
                if (defaultConfig.autoRotationDisabled === undefined || defaultConfig.autoRotationDisabled === null) {
                    defaultConfig.autoRotationDisabled = false;
                }
                return defaultConfig;
            },

            setConfig: function (obj) {
                var v = Config.validate(obj);
                if (!v.valid) return false;
                var toStore = v.config;
                try {
                    localStorage.setItem(Config.CONFIG_KEY, JSON.stringify(toStore));
                    Config.memoryConfig = null;
                    return true;
                } catch (e) {
                    Config.memoryConfig = toStore;
                    return true;
                }
            },

            clear: function () {
                Config.memoryConfig = null;
                try { localStorage.removeItem(Config.CONFIG_KEY); } catch (e) { /* ignore */ }
            }
        };

        // === ROTATION ===
        // Iframe lifecycle, timing, transitions. Idempotent init; pause/resume for overlay.
        var rotationTimeoutId = null, currentIndex = 0, currentApps = [];
        var container = document.getElementById('app-container');
        var isAutoMode = true; // true = auto rotation, false = manual selection
        var autoResumeTimeoutId = null;
        var autoResumeTimeout = 10000; // default 10 seconds in milliseconds
        var autoRotationDisabled = false; // true = auto rotation completely disabled

        var Rotation = {
            init: function (preserveState) {
                if (rotationTimeoutId) { clearTimeout(rotationTimeoutId); rotationTimeoutId = null; }
                if (autoResumeTimeoutId) { clearTimeout(autoResumeTimeoutId); autoResumeTimeoutId = null; }
                var cfg = Config.getConfig();
                currentApps = cfg.apps;
                autoResumeTimeout = (cfg.autoResumeTimeout !== undefined && cfg.autoResumeTimeout !== null) ? cfg.autoResumeTimeout : 10000;
                autoRotationDisabled = (cfg.autoRotationDisabled === true) ? true : false;
                if (!preserveState) {
                    currentIndex = 0;
                    isAutoMode = !autoRotationDisabled; // Start in auto mode only if not disabled
                }
                container.innerHTML = '';
                currentApps.forEach(function (app, i) {
                    var iframe = document.createElement('iframe');
                    iframe.src = app.url;
                    iframe.id = 'frame-' + i;
                    if (i === currentIndex) iframe.classList.add('active');
                    container.appendChild(iframe);
                });
                if ((!preserveState || isAutoMode) && !autoRotationDisabled) {
                    Rotation.rotate();
                }
                updateStreamListPanel(); // Update stream list when rotation is initialized
            },

            rotate: function () {
                if (currentApps.length === 0 || !isAutoMode || autoRotationDisabled) return;
                var app = currentApps[currentIndex];
                var nextIndex = (currentIndex + 1) % currentApps.length;
                rotationTimeoutId = setTimeout(function () {
                    console.log('[HUD] Switching to app index: ' + nextIndex);
                    var cur = document.getElementById('frame-' + currentIndex);
                    if (cur) cur.classList.remove('active');
                    var next = document.getElementById('frame-' + nextIndex);
                    if (next) next.classList.add('active');
                    currentIndex = nextIndex;
                    updateStreamListPanel(); // Update stream list to highlight active stream
                    Rotation.rotate();
                }, app.duration);
            },

            pause: function () {
                if (rotationTimeoutId) { clearTimeout(rotationTimeoutId); rotationTimeoutId = null; }
            },

            resume: function () {
                if (isAutoMode) Rotation.rotate();
            },

            selectStream: function (index) {
                if (index < 0 || index >= currentApps.length) {
                    console.log('[HUD] Invalid stream index:', index);
                    return;
                }
                Rotation.pause();
                isAutoMode = false;
                var cur = document.getElementById('frame-' + currentIndex);
                if (cur) cur.classList.remove('active');
                var selected = document.getElementById('frame-' + index);
                if (selected) {
                    selected.classList.add('active');
                    console.log('[HUD] Manually selected stream:', index, currentApps[index].id);
                }
                currentIndex = index;
                updateModeUI(); // This will update the toggle to reflect manual mode
                updateStreamListPanel(); // Update stream list to highlight active stream
                Rotation.startAutoResumeTimer();
            },

            enableAuto: function () {
                if (autoRotationDisabled) return; // Can't enable if disabled
                isAutoMode = true;
                Rotation.stopAutoResumeTimer();
                Rotation.rotate();
                updateModeUI();
            },

            startAutoResumeTimer: function () {
                Rotation.stopAutoResumeTimer();
                if (autoResumeTimeout <= 0) return; // disabled
                if (autoRotationDisabled) return; // auto rotation is disabled
                autoResumeTimeoutId = setTimeout(function () {
                    if (!isAutoMode && !autoRotationDisabled) {
                        console.log('[HUD] Auto-resuming rotation after idle timeout');
                        Rotation.enableAuto();
                    }
                }, autoResumeTimeout);
            },

            stopAutoResumeTimer: function () {
                if (autoResumeTimeoutId) {
                    clearTimeout(autoResumeTimeoutId);
                    autoResumeTimeoutId = null;
                }
            },

            onMouseMove: function () {
                // Don't do anything if auto rotation is disabled
                if (autoRotationDisabled) return;
                
                // Turn off auto rotation when mouse moves
                if (isAutoMode) {
                    Rotation.pause();
                    isAutoMode = false;
                    updateModeUI();
                    // Start auto-resume timer if enabled
                    if (autoResumeTimeout > 0) {
                        Rotation.startAutoResumeTimer();
                    }
                } else if (autoResumeTimeout > 0) {
                    // Already in manual mode, just reset the auto-resume timer
                    Rotation.startAutoResumeTimer();
                }
            }
        };

        // === OVERLAY ===
        // Settings panel: reads/writes via Config; controls Rotation (pause/resume/init).
        var panel = document.getElementById('settings-panel');
        var appList = document.getElementById('app-list');
        var menuTrigger = document.getElementById('menu-trigger');
        var panelSettingsBtn = document.getElementById('panel-settings-btn');
        var streamListPanel = document.getElementById('stream-list-panel');
        var streamListContent = document.getElementById('stream-list-content');

        function createAppRow(app, index) {
            var row = document.createElement('div');
            row.className = 'app-row';
            row.dataset.index = index;
            var idIn = document.createElement('input');
            idIn.className = 'row-id';
            idIn.placeholder = 'Name';
            idIn.type = 'text';
            if (app && app.id) idIn.value = app.id;
            var urlIn = document.createElement('input');
            urlIn.className = 'row-url';
            urlIn.placeholder = 'https://...';
            urlIn.type = 'text';
            if (app && app.url) urlIn.value = app.url;
            var durIn = document.createElement('input');
            durIn.className = 'row-duration';
            durIn.type = 'number';
            durIn.min = '10';
            durIn.max = '86400';
            durIn.placeholder = 'sec';
            durIn.value = app ? Math.round(app.duration / 1000) : 60;
            var rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'btn-remove';
            rm.textContent = 'Remove';
            
            var selectBtn = document.createElement('button');
            selectBtn.type = 'button';
            selectBtn.className = 'btn-select';
            selectBtn.textContent = 'Show';
            selectBtn.dataset.index = index;
            selectBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                var idx = parseInt(selectBtn.dataset.index, 10);
                if (!isNaN(idx)) {
                    Rotation.selectStream(idx);
                    updateStreamSelectionUI();
                }
            });
            
            row.appendChild(idIn);
            row.appendChild(urlIn);
            row.appendChild(durIn);
            row.appendChild(selectBtn);
            row.appendChild(rm);
            
            return row;
        }

        function populateForm() {
            appList.innerHTML = '';
            var cfg = Config.getConfig();
            cfg.apps.forEach(function (a, i) { 
                appList.appendChild(createAppRow(a, i)); 
            });
            
            // Disable Auto Rotation toggle
            var disableAutoToggle = document.getElementById('disable-auto-rotation');
            var isAutoRotationDisabled = (cfg.autoRotationDisabled === true);
            if (disableAutoToggle) {
                disableAutoToggle.checked = isAutoRotationDisabled;
            }
            
            // Auto-resume settings
            var toggleEnabled = document.getElementById('auto-resume-enabled');
            var timeoutInput = document.getElementById('auto-resume-timeout');
            var timeInputGroup = document.getElementById('time-input-group');
            var autoResumeSetting = document.querySelector('.auto-resume-setting');
            var savedTimeout = (cfg.autoResumeTimeout !== undefined && cfg.autoResumeTimeout !== null) ? cfg.autoResumeTimeout : 10000;
            var isEnabled = savedTimeout > 0;
            
            if (toggleEnabled) {
                toggleEnabled.checked = isEnabled;
                toggleEnabled.disabled = isAutoRotationDisabled; // Disable if auto rotation is disabled
            }
            if (timeoutInput) {
                timeoutInput.value = isEnabled ? Math.round(savedTimeout / 1000) : 10;
                timeoutInput.disabled = isAutoRotationDisabled; // Disable if auto rotation is disabled
            }
            if (timeInputGroup) {
                if (isEnabled && !isAutoRotationDisabled) {
                    timeInputGroup.classList.remove('hidden');
                } else {
                    timeInputGroup.classList.add('hidden');
                }
            }
            if (autoResumeSetting) {
                if (isAutoRotationDisabled) {
                    autoResumeSetting.classList.add('disabled');
                } else {
                    autoResumeSetting.classList.remove('disabled');
                }
            }
            updateModeUI();
            updateStreamSelectionUI();
        }

        function updateModeUI() {
            // Update the disable toggle to reflect current state
            // If auto rotation is disabled, the toggle should be checked
            var disableToggle = document.getElementById('disable-auto-rotation');
            if (disableToggle) {
                disableToggle.checked = autoRotationDisabled;
            }
        }

        function updateStreamSelectionUI() {
            var rows = appList.querySelectorAll('.app-row');
            rows.forEach(function(row, i) {
                var selectBtn = row.querySelector('.btn-select');
                if (!isAutoMode && i === currentIndex) {
                    row.classList.add('selected');
                    if (selectBtn) {
                        selectBtn.classList.add('active');
                        selectBtn.textContent = 'Showing';
                    }
                } else {
                    row.classList.remove('selected');
                    if (selectBtn) {
                        selectBtn.classList.remove('active');
                        selectBtn.textContent = 'Show';
                    }
                }
            });
            updateStreamListPanel();
        }

        function updateStreamListPanel() {
            if (!streamListContent) return;
            streamListContent.innerHTML = '';
            var cfg = Config.getConfig();
            cfg.apps.forEach(function(app, index) {
                var item = document.createElement('div');
                item.className = 'stream-list-item';
                if (index === currentIndex) {
                    item.classList.add('active');
                }
                item.dataset.index = index;
                
                var nameDiv = document.createElement('div');
                nameDiv.className = 'stream-name';
                nameDiv.textContent = app.id || 'Stream ' + (index + 1);
                
                var urlDiv = document.createElement('div');
                urlDiv.className = 'stream-url';
                urlDiv.textContent = app.url;
                
                item.appendChild(nameDiv);
                item.appendChild(urlDiv);
                
                item.addEventListener('click', function() {
                    var idx = parseInt(item.dataset.index, 10);
                    if (!isNaN(idx)) {
                        Rotation.selectStream(idx);
                        updateStreamSelectionUI();
                    }
                });
                
                streamListContent.appendChild(item);
            });
        }

        function openSettings() {
            Rotation.pause();
            document.body.classList.add('settings-open');
            panel.classList.add('is-open');
            // Hide stream list panel when settings open
            if (streamListPanel) {
                streamListPanel.classList.remove('visible');
            }
            populateForm();
            var first = appList.querySelector('.row-url');
            if (first) first.focus();
        }

        // Stream list panel hover handlers
        var streamListHoverTimeout = null;
        function showStreamList() {
            if (streamListHoverTimeout) {
                clearTimeout(streamListHoverTimeout);
                streamListHoverTimeout = null;
            }
            if (streamListPanel) {
                streamListPanel.classList.add('visible');
                updateStreamListPanel();
            }
        }
        function hideStreamList() {
            if (streamListHoverTimeout) {
                clearTimeout(streamListHoverTimeout);
            }
            streamListHoverTimeout = setTimeout(function() {
                if (streamListPanel) {
                    streamListPanel.classList.remove('visible');
                }
            }, 200); // Small delay to allow moving from button to panel
        }
        

        function closeSettings(shouldReload) {
            panel.classList.remove('is-open');
            document.body.classList.remove('settings-open');
            if (shouldReload) {
                // Preserve current state before reloading
                var preservedMode = isAutoMode;
                var preservedIndex = currentIndex;
                // Check if preserved index is still valid after reload
                var cfg = Config.getConfig();
                var maxIndex = cfg.apps.length - 1;
                if (preservedIndex > maxIndex) preservedIndex = maxIndex;
                if (preservedIndex < 0) preservedIndex = 0;
                
                // Init with state preservation
                Rotation.init(true);
                
                // Restore the preserved state
                if (!preservedMode) {
                    // Was in manual mode, restore it
                    isAutoMode = false;
                    Rotation.pause();
                    // Show the preserved stream
                    var cur = document.getElementById('frame-' + currentIndex);
                    if (cur) cur.classList.remove('active');
                    var selected = document.getElementById('frame-' + preservedIndex);
                    if (selected) {
                        selected.classList.add('active');
                        currentIndex = preservedIndex;
                    }
                    Rotation.startAutoResumeTimer();
                } else {
                    // Was in auto mode, ensure rotation continues
                    currentIndex = preservedIndex;
                    var cur = document.getElementById('frame-' + currentIndex);
                    if (cur) {
                        // Make sure the current frame is active
                        document.querySelectorAll('iframe').forEach(function(f) { f.classList.remove('active'); });
                        cur.classList.add('active');
                    }
                    Rotation.rotate();
                }
                updateModeUI();
            } else {
                Rotation.resume();
            }
        }

        function collectForm() {
            var rows = appList.querySelectorAll('.app-row');
            var apps = [];
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var id = (r.querySelector('.row-id').value || '').trim();
                var url = (r.querySelector('.row-url').value || '').trim();
                var sec = parseInt(r.querySelector('.row-duration').value, 10);
                if (!url) continue;
                if (!/^https?:\/\//i.test(url)) return { err: 'Invalid URL: must start with http:// or https://' };
                if (isNaN(sec) || sec < 10 || sec > 86400) return { err: 'Duration must be between 10 and 86400 seconds' };
                apps.push({ id: id || 'app-' + i, url: url, duration: sec * 1000 });
            }
            if (apps.length === 0) return { err: 'At least one app is required' };
            var disableAutoToggle = document.getElementById('disable-auto-rotation');
            var autoRotationDisabled = disableAutoToggle ? disableAutoToggle.checked : false;
            var toggleEnabled = document.getElementById('auto-resume-enabled');
            var timeoutInput = document.getElementById('auto-resume-timeout');
            var isEnabled = toggleEnabled ? toggleEnabled.checked : false;
            var timeoutSec = 0;
            if (isEnabled) {
                timeoutSec = timeoutInput ? parseInt(timeoutInput.value, 10) : 10;
                if (isNaN(timeoutSec) || timeoutSec < 1 || timeoutSec > 300) return { err: 'Auto-resume timeout must be between 1 and 300 seconds when enabled' };
            }
            return { apps: apps, autoResumeTimeout: timeoutSec * 1000, autoRotationDisabled: autoRotationDisabled };
        }

        function onSave() {
            var out = collectForm();
            if (out.err) { alert(out.err); return; }
            if (!Config.setConfig({ apps: out.apps, autoResumeTimeout: out.autoResumeTimeout })) { alert('Invalid configuration.'); return; }
            closeSettings(true);
        }

        function onReset() {
            if (!confirm('Reset to default playlist? This cannot be undone.')) return;
            Config.clear();
            closeSettings(true);
        }

        appList.addEventListener('click', function (e) {
            if (e.target && e.target.classList.contains('btn-remove')) {
                e.stopPropagation();
                var row = e.target.closest('.app-row');
                if (row) row.remove();
            }
        });
        document.getElementById('btn-add-app').addEventListener('click', function () { 
            var newIndex = appList.querySelectorAll('.app-row').length;
            appList.appendChild(createAppRow(null, newIndex)); 
        });
        document.getElementById('auto-resume-enabled').addEventListener('change', function(e) {
            var timeInputGroup = document.getElementById('time-input-group');
            if (timeInputGroup) {
                if (e.target.checked) {
                    timeInputGroup.classList.remove('hidden');
                } else {
                    timeInputGroup.classList.add('hidden');
                }
            }
        });
        document.getElementById('disable-auto-rotation').addEventListener('change', function(e) {
            autoRotationDisabled = e.target.checked;
            var autoResumeToggle = document.getElementById('auto-resume-enabled');
            var timeoutInput = document.getElementById('auto-resume-timeout');
            var timeInputGroup = document.getElementById('time-input-group');
            var autoResumeSetting = document.querySelector('.auto-resume-setting');
            
            if (autoRotationDisabled) {
                // Disable auto rotation - pause and stop
                Rotation.pause();
                isAutoMode = false;
                Rotation.stopAutoResumeTimer(); // Stop any auto-resume timers
                
                // Disable auto-resume toggle and input
                if (autoResumeToggle) autoResumeToggle.disabled = true;
                if (timeoutInput) timeoutInput.disabled = true;
                if (timeInputGroup) timeInputGroup.classList.add('hidden');
                if (autoResumeSetting) autoResumeSetting.classList.add('disabled');
            } else {
                // Re-enable auto rotation - can start if not in manual mode
                // Don't auto-start, let user control it
                // Note: auto-resume timer will work again if mouse stops moving
                
                // Enable auto-resume toggle and input
                if (autoResumeToggle) autoResumeToggle.disabled = false;
                if (timeoutInput) timeoutInput.disabled = false;
                if (autoResumeSetting) autoResumeSetting.classList.remove('disabled');
                // Show time input if auto-resume is enabled
                if (autoResumeToggle && autoResumeToggle.checked && timeInputGroup) {
                    timeInputGroup.classList.remove('hidden');
                }
            }
            updateModeUI();
        });
        document.getElementById('btn-save').addEventListener('click', onSave);
        document.getElementById('btn-cancel').addEventListener('click', function () { closeSettings(false); });
        document.getElementById('btn-reset').addEventListener('click', onReset);
        document.getElementById('settings-overlay').addEventListener('click', function () { closeSettings(false); });
        
        // Settings button in panel
        if (panelSettingsBtn) {
            panelSettingsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                openSettings();
            });
        }
        
        // Stream list panel hover events
        if (menuTrigger && streamListPanel) {
            menuTrigger.addEventListener('mouseenter', showStreamList);
            menuTrigger.addEventListener('mouseleave', hideStreamList);
            streamListPanel.addEventListener('mouseenter', function() {
                if (streamListHoverTimeout) {
                    clearTimeout(streamListHoverTimeout);
                    streamListHoverTimeout = null;
                }
            });
            streamListPanel.addEventListener('mouseleave', hideStreamList);
        }
        
        panel.addEventListener('keydown', function (e) { if (e.key === 'Escape') { e.preventDefault(); closeSettings(false); } });
        document.addEventListener('keydown', function (e) { if (e.ctrlKey && e.shiftKey && e.key === 'S') { e.preventDefault(); openSettings(); } });

        // === MOUSE MOVEMENT TRACKING ===
        document.addEventListener('mousemove', function() {
            Rotation.onMouseMove();
        });

        // === STARTUP ===
        Rotation.init();
        updateStreamListPanel(); // Initialize stream list panel
        if (window.location.search.indexOf('settings') !== -1 || window.location.hash === '#settings') { openSettings(); }
    </script>
</body>
</html>
